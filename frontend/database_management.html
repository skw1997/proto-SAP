<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .editable-cell {
            cursor: pointer;
            padding: 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
            min-height: 38px;
            display: table-cell;
            vertical-align: middle;
        }
        .editable-cell:hover {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .editing-cell {
            padding: 0;
        }
        .editing-cell input, .editing-cell select {
            width: 100%;
            border: 1px solid #007bff;
            padding: 8px;
            box-sizing: border-box;
        }
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .filter-row {
            margin-bottom: 10px;
        }
        .filter-row .form-control {
            width: 100%;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .table th, .table td {
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table-responsive {
            overflow-x: auto;
        }
        /* 数据验证错误行样式 */
        .invalid-row {
            background-color: #f8d7da !important;
            color: #721c24;
        }
        .invalid-row:hover {
            background-color: #f1b0b7 !important;
        }
        .invalid-row td {
            border-color: #f5c6cb !important;
        }
        /* 检索框样式调整 */
        .filter-row .col {
            padding-left: 2px;
            padding-right: 2px;
        }
        .filter-row .form-control-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        /* 清除按钮样式 */
        .clear-filter-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1>采购订单管理系统</h1>
            <div class="user-info">
                <span id="currentUser">未登录</span>
                <a href="/register.html" id="registerLink">注册</a>
                <a href="/login.html" id="loginLink" style="display: inline-block;">登录</a>
                <button id="logoutBtn" style="display: none;">退出</button>
            </div>
        </div>
        
        <!-- 导航按钮 -->
        <div class="mb-3">
            <a href="/" class="btn btn-primary">
                <i class="bi bi-table"></i> 数据库管理
            </a>
            <a href="/pdf_import.html" class="btn btn-secondary">
                <i class="bi bi-cloud-upload"></i> PDF导入
            </a>
        </div>
        
        <!-- 状态消息区域 -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <!-- 表选择 -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="tableSelect" class="form-label">选择要管理的表</label>
                <select class="form-select" id="tableSelect">
                    <option value="wf_open">WF Open</option>
                    <option value="wf_closed">WF Closed</option>
                    <option value="non_wf_open">Non-WF Open</option>
                    <option value="non_wf_closed">Non-WF Closed</option>
                </select>
            </div>
            <div class="col-md-8 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="loadTableData()">
                    <i class="bi bi-arrow-repeat"></i> 刷新数据
                </button>
                <button class="btn btn-success" onclick="showInsertForm()">
                    <i class="bi bi-plus-circle"></i> 插入新记录
                </button>
            </div>
        </div>
        
        <!-- 插入表单 (默认隐藏) -->
        <div id="insertForm" class="table-container" style="display: none;">
            <h5>插入新记录</h5>
            <div id="insertFormFields" class="row"></div>
            <div class="mt-3">
                <button class="btn btn-success me-2" onclick="insertRecord()">插入记录</button>
                <button class="btn btn-secondary" onclick="hideInsertForm()">取消</button>
            </div>
        </div>
        
        <!-- 删除功能 -->
        <div class="table-container mb-3">
            <h5>删除记录</h5>
            <div class="row">
                <div class="col-md-4">
                    <label for="deletePN" class="form-label">输入要删除的记录的PN号</label>
                    <input type="text" class="form-control" id="deletePN" placeholder="输入PN号">
                </div>
                <div class="col-md-8 d-flex align-items-end">
                    <button class="btn btn-danger" onclick="deleteRecord()">
                        <i class="bi bi-trash"></i> 删除记录
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <div class="table-container">
            <h5 id="tableTitle">WF Open 表数据</h5>
            <div id="filterRow" class="filter-row"></div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead id="tableHeader">
                        <!-- 表头将通过JavaScript动态生成 -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- 表体将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            <div id="recordCount" class="mt-2 text-muted"></div>
        </div>
    </div>

    <!-- Bootstrap Modal for Confirmation -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    确认要执行此操作吗？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">确认</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 检查用户是否已登录
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                // 未登录，跳转到登录页面
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        // 在页面加载时检查登录状态
        if (!checkLoginStatus()) {
            // 如果未登录，阻止页面继续加载
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>请先登录</h2><p>正在跳转到登录页面...</p></div>';
            });
        }
        
        // 全局变量
        let currentTable = 'wf_open';
        let tableData = [];
        let originalData = [];
        let columnNames = [];
        let dateColumns = ['req_date_wf', 'eta_wfsz', 'latest_departure_date', 'po_placed_date'];
        let currentEditingCell = null; // 跟踪当前正在编辑的单元格
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            if (!checkLoginStatus()) {
                return;
            }
            
            // 显示当前用户
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser.email;
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('registerLink').style.display = 'none';
            }
            
            loadTableData();
            
            // 监听表选择变化
            document.getElementById('tableSelect').addEventListener('change', function() {
                currentTable = this.value;
                loadTableData();
            });
            
            // 监听全局键盘事件
            document.addEventListener('keydown', function(event) {
                if (currentEditingCell) {
                    if (event.key === 'Escape') {
                        // ESC键取消编辑
                        const input = currentEditingCell.querySelector('input');
                        if (input) {
                            const originalValue = input.getAttribute('data-original-value');
                            input.value = originalValue || '';
                            // 触发change事件更新数据模型
                            input.dispatchEvent(new Event('change'));
                            // 结束编辑状态
                            currentEditingCell.textContent = originalValue || '';
                            currentEditingCell.classList.remove('editing-cell');
                            currentEditingCell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    } else if (event.key === 'Enter') {
                        // Enter键保存编辑
                        const input = currentEditingCell.querySelector('input');
                        if (input) {
                            input.dispatchEvent(new Event('change'));
                            currentEditingCell.textContent = input.value || '';
                            currentEditingCell.classList.remove('editing-cell');
                            currentEditingCell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    }
                }
            });
            
            // 添加退出按钮事件监听
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                window.location.href = '/login.html';
            });
        });
        
        // 带认证的fetch函数
        function authenticatedFetch(url, options = {}) {
            // 获取存储的token
            const token = localStorage.getItem('authToken');
            if (!token) {
                // 如果没有token，跳转到登录页面
                window.location.href = '/login.html';
                throw new Error('未登录');
            }
            
            // 添加认证头
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // 添加用户邮箱头
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.email) {
                options.headers['X-User-Email'] = currentUser.email;
            }
            
            return fetch(url, options)
                .then(response => {
                    if (response.status === 401) {
                        // Token无效或过期，清除本地存储并跳转到登录页面
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                        throw new Error('认证失败，请重新登录');
                    }
                    return response;
                })
                .catch(error => {
                    if (error.message === '认证失败，请重新登录') {
                        throw error;
                    }
                    // 其他错误继续抛出
                    throw error;
                });
        }
        
        // 获取表的列名
        function getColumnNames(tableName) {
            // 根据表名返回对应的列顺序
            const tableColumns = {
                'wf_open': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'latest_departure_date', 'chinese_name', 'unit'],
                'wf_closed': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'chinese_name', 'unit'],
                'non_wf_open': ['po', 'pn', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'qc_result', 'shipping_cost', 'tracking_no', 'so_number', 'yes_not_paid'],
                'non_wf_closed': ['po', 'pn', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'shipping_cost', 'tracking_no', 'so_number', 'yes_not_paid']
            };
            
            // 返回对应表的列顺序，如果没有定义则返回默认顺序
            return tableColumns[tableName] || ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'po_placed_date', 'purchaser'];
        }
        
        // 加载表数据
        function loadTableData() {
            showStatus('正在加载数据...', 'loading');
            
            authenticatedFetch(`/api/tables/${currentTable}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        tableData = data.data;
                        // 根据表名获取正确的列顺序
                        columnNames = getColumnNames(currentTable);
                        originalData = JSON.parse(JSON.stringify(tableData));
                        renderTable();
                        hideStatus();
                    } else {
                        showStatus(`加载数据失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`加载数据失败: ${error}`, 'error');
                });
        }
        
        // 渲染表格
        function renderTable() {
            renderTableHeader();
            renderTableBody();
            renderFilterRow();
            updateRecordCount();
            updateTableTitle();
        }
        
        // 渲染表头
        function renderTableHeader() {
            const header = document.getElementById('tableHeader');
            header.innerHTML = '';
            
            let headerRow = '<tr>';
            columnNames.forEach(col => {
                headerRow += `<th>${col}</th>`;
            });
            headerRow += '<th>操作</th>';
            headerRow += '</tr>';
            
            header.innerHTML = headerRow;
        }
        
        // 渲染表体
        function renderTableBody() {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            
            let tableHtml = '';
            tableData.forEach((row, rowIndex) => {
                // 检查 qty*net_price 是否等于 total_price
                const qty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = qty * netPrice;
                
                // 检查计算值是否与总价匹配（考虑浮点数精度问题）
                const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
                
                // 构建行的class属性
                let rowClass = '';
                if (isInvalidRow) {
                    rowClass = 'invalid-row';
                }
                
                let rowHtml = `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                
                columnNames.forEach(col => {
                    const value = row[col] !== null ? row[col] : '';
                    // 格式化日期值
                    let displayValue = value;
                    if (value && typeof value === 'object' && value.hasOwnProperty('$$date')) {
                        // 处理特殊日期格式
                        const date = new Date(value.$$date);
                        displayValue = date.toLocaleDateString('zh-CN');
                    } else if (value && typeof value === 'string' && value.includes('GMT')) {
                        // 处理GMT日期字符串
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                displayValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            // 如果不是有效日期，保持原值
                            displayValue = value;
                        }
                    } else if (value === null || value === 'None' || value === 'null') {
                        displayValue = '';
                    }
                    
                    // 确保特殊字符被正确转义
                    const escapedValue = String(displayValue).replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    
                    rowHtml += `<td class="editable-cell" data-column="${col}" data-row="${rowIndex}" onclick="editCell(this)">${escapedValue}</td>`;
                });
                
                rowHtml += `<td>
                    <button class="btn btn-sm btn-primary me-1" onclick="saveRow(${rowIndex})">
                        <i class="bi bi-save"></i> 保存
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="cancelEdit(${rowIndex})">
                        <i class="bi bi-x-circle"></i> 取消
                    </button>
                </td>`;
                
                rowHtml += '</tr>';
                tableHtml += rowHtml;
            });
            
            body.innerHTML = tableHtml;
            
            // 为无效行添加title提示
            tableData.forEach((row, rowIndex) => {
                const qty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = qty * netPrice;
                
                // 检查计算值是否与总价匹配（考虑浮点数精度问题）
                if (qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01) {
                    const rowElement = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                    if (rowElement) {
                        rowElement.title = `数据不一致: qty(${qty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} ≠ total_price(${totalPrice})`;
                    }
                }
            });
        }
        
        // 渲染过滤行
        function renderFilterRow() {
            const filterRow = document.getElementById('filterRow');
            filterRow.innerHTML = '';
            
            // 创建一个单独的行用于过滤器
            let filterHtml = '<div class="row">';
            
            // 为每个数据列创建过滤器
            columnNames.forEach((col, index) => {
                filterHtml += `
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" 
                               placeholder="${col}" 
                               data-column="${col}"
                               oninput="filterTable(this)">
                    </div>
                `;
            });
            
            // 为操作列留空并添加清除按钮
            filterHtml += `
                <div class="col">
                    <button class="btn btn-sm btn-outline-secondary clear-filter-btn" onclick="clearAllFilters()">
                        <i class="bi bi-x-circle"></i> 清除
                    </button>
                </div>
            `;
            
            filterHtml += '</div>';
            
            filterRow.innerHTML = filterHtml;
            
            // 设置过滤器事件
            setupFilterEvents();
        }
        
        // 取消编辑
        function cancelEdit(rowIndex) {
            // 恢复原始数据
            tableData[rowIndex] = JSON.parse(JSON.stringify(originalData[rowIndex]));
            renderTableBody();
        }
        
        // 过滤表格
        function filterTable(input) {
            const column = input.getAttribute('data-column');
            const filterValue = input.value.toLowerCase();
            
            // 获取所有表格行
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                // 获取该行中对应列的单元格
                const cells = row.querySelectorAll('td');
                let match = false;
                
                // 遍历所有列，检查是否有过滤器有值
                columnNames.forEach((col, index) => {
                    const filterInput = document.querySelector(`input[data-column="${col}"]`);
                    if (filterInput && filterInput.value) {
                        const cellValue = cells[index].textContent.toLowerCase();
                        if (cellValue.includes(filterInput.value.toLowerCase())) {
                            match = true;
                        } else {
                            match = false;
                            return;
                        }
                    }
                });
                
                // 如果没有过滤器有值，则显示所有行
                if (!document.querySelector('input[data-column].filter-input') || 
                    !Array.from(document.querySelectorAll('input[data-column]')).some(input => input.value)) {
                    row.style.display = '';
                } else {
                    // 根据匹配结果显示或隐藏行
                    row.style.display = match ? '' : 'none';
                }
            });
        }
        
        // 添加一个专门的搜索函数
        function searchTable() {
            // 获取所有过滤器输入框
            const filterInputs = document.querySelectorAll('input[data-column]');
            
            // 获取所有表格行
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                let showRow = true;
                
                // 检查每个过滤器
                filterInputs.forEach(input => {
                    const column = input.getAttribute('data-column');
                    const filterValue = input.value.toLowerCase();
                    
                    if (filterValue) {
                        // 找到对应列的索引
                        const columnIndex = columnNames.indexOf(column);
                        if (columnIndex !== -1) {
                            // 获取该行对应列的单元格
                            const cell = row.cells[columnIndex];
                            if (cell) {
                                const cellValue = cell.textContent.toLowerCase();
                                // 如果单元格值不包含过滤值，则隐藏该行
                                if (!cellValue.includes(filterValue)) {
                                    showRow = false;
                                }
                            }
                        }
                    }
                });
                
                // 根据结果显示或隐藏行
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // 为过滤器添加回车键事件
        function setupFilterEvents() {
            const filterInputs = document.querySelectorAll('input[data-column]');
            filterInputs.forEach(input => {
                input.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        searchTable();
                    }
                });
            });
        }
        
        // 显示插入表单
        function showInsertForm() {
            const formFields = document.getElementById('insertFormFields');
            formFields.innerHTML = '';
            
            // 为每个列创建输入字段
            columnNames.forEach(col => {
                const div = document.createElement('div');
                div.className = 'col-md-3 mb-3';
                div.innerHTML = `
                    <label for="insert_${col}" class="form-label">${col}</label>
                    <input type="text" class="form-control form-control-sm" id="insert_${col}" name="${col}">
                `;
                formFields.appendChild(div);
            });
            
            document.getElementById('insertForm').style.display = 'block';
        }
        
        // 隐藏插入表单
        function hideInsertForm() {
            document.getElementById('insertForm').style.display = 'none';
        }
        
        // 清除所有过滤器
        function clearAllFilters() {
            // 清除所有过滤器输入框的值
            const filterInputs = document.querySelectorAll('input[data-column]');
            filterInputs.forEach(input => {
                input.value = '';
            });
            
            // 显示所有行
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // 显示确认对话框
        function showConfirmModal(message, confirmCallback) {
            // 设置模态框内容
            document.getElementById('confirmModalBody').innerHTML = message;
            
            // 设置确认按钮的点击事件
            const confirmButton = document.getElementById('confirmModalButton');
            // 清除之前的事件监听器
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // 添加新的点击事件监听器
            newConfirmButton.onclick = function() {
                // 关闭模态框
                const modalElement = document.getElementById('confirmModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                // 执行确认回调
                if (confirmCallback && typeof confirmCallback === 'function') {
                    confirmCallback();
                }
            };
            
            // 显示模态框
            const modalElement = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // 编辑单元格
        function editCell(cell) {
            // 如果有正在编辑的单元格，先取消它的编辑状态
            if (currentEditingCell && currentEditingCell !== cell) {
                // 检查当前编辑的单元格是否有未保存的更改
                const input = currentEditingCell.querySelector('input');
                if (input) {
                    // 触发change事件保存更改
                    input.dispatchEvent(new Event('change'));
                }
                // 恢复单元格显示
                const originalValue = currentEditingCell.getAttribute('data-original-value');
                currentEditingCell.textContent = originalValue || '';
                currentEditingCell.classList.remove('editing-cell');
                currentEditingCell.classList.add('editable-cell');
            }
            
            // 如果点击的是已经处于编辑状态的单元格，则不做任何操作
            if (cell.classList.contains('editing-cell')) {
                return;
            }
            
            const rowIndex = parseInt(cell.getAttribute('data-row'));
            const columnName = cell.getAttribute('data-column');
            const currentValue = cell.textContent || '';
            
            // 保存原始值
            cell.setAttribute('data-original-value', currentValue);
            
            // 根据列名判断输入类型
            let inputHtml = '';
            if (dateColumns.includes(columnName)) {
                // 对于日期字段，确保值格式正确
                let dateValue = currentValue;
                if (currentValue && currentValue !== 'null' && currentValue !== 'None') {
                    // 如果是日期对象，格式化为 YYYY-MM-DD
                    if (currentValue instanceof Date) {
                        dateValue = currentValue.toISOString().split('T')[0];
                    } else if (typeof currentValue === 'string' && currentValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                        // 已经是正确格式
                        dateValue = currentValue;
                    } else if (typeof currentValue === 'string' && currentValue.includes('GMT')) {
                        // 处理GMT日期字符串
                        try {
                            const date = new Date(currentValue);
                            if (!isNaN(date.getTime())) {
                                dateValue = date.toISOString().split('T')[0];
                            }
                        } catch (e) {
                            dateValue = currentValue;
                        }
                    }
                } else {
                    dateValue = '';
                }
                inputHtml = `<input type="date" class="date-input" value="${dateValue}" 
                                     onchange="updateCellValue(${rowIndex}, '${columnName}', this.value)"
                                     data-original-value="${dateValue}">`;
            } else {
                inputHtml = `<input type="text" value="${currentValue}" 
                                     onchange="updateCellValue(${rowIndex}, '${columnName}', this.value)"
                                     data-original-value="${currentValue}">`;
            }
            
            cell.innerHTML = inputHtml;
            cell.classList.add('editing-cell');
            cell.classList.remove('editable-cell');
            
            // 聚焦到新创建的输入框
            const input = cell.querySelector('input');
            if (input) {
                input.focus();
                // 选择所有文本以便编辑
                input.select();
                
                // 为输入框添加键盘事件监听
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        event.stopPropagation();
                        // ESC键取消编辑，恢复原始值
                        const originalValue = input.getAttribute('data-original-value');
                        input.value = originalValue || '';
                        // 触发change事件更新数据模型
                        input.dispatchEvent(new Event('change'));
                        // 结束编辑状态
                        cell.textContent = originalValue || '';
                        cell.classList.remove('editing-cell');
                        cell.classList.add('editable-cell');
                        currentEditingCell = null;
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        event.stopPropagation();
                        // Enter键保存编辑
                        input.dispatchEvent(new Event('change'));
                        cell.textContent = input.value || '';
                        cell.classList.remove('editing-cell');
                        cell.classList.add('editable-cell');
                        currentEditingCell = null;
                    }
                });
                
                // 监听输入框失去焦点事件
                input.addEventListener('blur', function() {
                    // 延迟执行，确保不会与点击事件冲突
                    setTimeout(() => {
                        if (currentEditingCell === cell) {
                            // 触发change事件保存更改
                            input.dispatchEvent(new Event('change'));
                            cell.textContent = input.value || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    }, 200);
                });
            }
            
            // 设置当前编辑的单元格
            currentEditingCell = cell;
        }
        
        // 更新单元格值
        function updateCellValue(rowIndex, columnName, value) {
            // 处理特殊值
            if (value === 'null' || value === 'None' || value === 'nan') {
                tableData[rowIndex][columnName] = null;
            } else {
                tableData[rowIndex][columnName] = value;
            }
            
            // 检查是否是qty或net_price列，如果是则自动计算total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                const totalPrice = (qty * netPrice).toFixed(2);
                
                // 更新total_price字段
                tableData[rowIndex]['total_price'] = totalPrice;
                
                // 更新表格中显示的total_price值
                const totalCell = document.querySelector(`td[data-column="total_price"][data-row="${rowIndex}"]`);
                if (totalCell) {
                    totalCell.textContent = totalPrice;
                }
            }
            
            // 实时保存到数据库
            saveCellValueToDatabase(rowIndex, columnName, value);
        }
        
        // 保存单元格编辑
        function saveCellEdit(cell) {
            // 触发输入框的change事件来保存值
            const input = cell.querySelector('input');
            if (input) {
                input.dispatchEvent(new Event('change'));
            }
            // 更新显示值
            if (input) {
                cell.textContent = input.value || '';
            }
            cell.classList.remove('editing-cell');
            cell.classList.add('editable-cell');
        }
        
        // 保存单元格数据（自动保存）
        function saveCellData(rowIndex, columnName, value) {
            // 更新数据模型
            tableData[rowIndex][columnName] = value;
            
            // 如果是qty或net_price，同时更新total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                tableData[rowIndex]['total_price'] = (qty * netPrice).toFixed(2);
            }
            
            // 获取主键值（假设为pn字段）
            const row = tableData[rowIndex];
            const pn = row.pn || row.PN;
            
            if (!pn) {
                showStatus('无法保存：缺少主键值(pn)', 'error');
                return;
            }
            
            // 准备更新数据
            const updates = {};
            updates[columnName] = value;
            
            // 如果是qty或net_price，同时发送total_price更新
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // 发送更新请求
            authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新原始数据
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`数据已保存: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // 重新验证该行数据（仅对数值列）
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`保存失败: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('保存数据时出错:', error);
                showStatus(`保存失败: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }
        
        // 实时保存单元格值到数据库
        function saveCellValueToDatabase(rowIndex, columnName, value) {
            // 获取要更新的数据
            const rowData = tableData[rowIndex];
            const pn = rowData.pn;
            
            // 构造更新数据
            const updates = {};
            updates[columnName] = value;
            
            // 如果是qty或net_price，同时更新total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // 发送更新请求
            authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新原始数据
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`数据已保存: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // 重新验证该行数据（仅对数值列）
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`保存失败: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('保存数据时出错:', error);
                showStatus(`保存失败: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }

        // 验证行数据
        function validateRow(rowIndex) {
            const row = tableData[rowIndex];
            // 确保必要的列存在
            if (!row.hasOwnProperty('qty') || !row.hasOwnProperty('net_price') || !row.hasOwnProperty('total_price')) {
                return;
            }
            
            const qty = parseFloat(row.qty) || 0;
            const netPrice = parseFloat(row.net_price) || 0;
            const totalPrice = parseFloat(row.total_price) || 0;
            const calculatedTotal = qty * netPrice;
            
            // 检查计算值是否与总价匹配（考虑浮点数精度问题）
            const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
            
            const rowElement = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (rowElement) {
                if (isInvalidRow) {
                    rowElement.classList.add('invalid-row');
                    rowElement.title = `数据不一致: qty(${qty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} ≠ total_price(${totalPrice})`;
                } else {
                    rowElement.classList.remove('invalid-row');
                    rowElement.title = '';
                }
            }
        }
        
        // 保存行数据
        function saveRow(rowIndex) {
            const row = tableData[rowIndex];
            const originalRow = originalData[rowIndex];
            
            // 检查是否有更改
            let hasChanges = false;
            for (let key in row) {
                if (row[key] !== originalRow[key]) {
                    hasChanges = true;
                    break;
                }
            }
            
            if (!hasChanges) {
                showStatus('没有更改需要保存', 'info');
                return;
            }
            
            // 获取主键值（假设为pn字段）
            const pn = row.pn || row.PN;
            if (!pn) {
                showStatus('无法保存：缺少主键值(pn)', 'error');
                return;
            }
            
            showStatus('正在保存数据...', 'loading');
            
            authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(row)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('数据保存成功', 'success');
                    // 更新原始数据副本
                    originalData[rowIndex] = JSON.parse(JSON.stringify(row));
                } else {
                    showStatus(`保存失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`保存失败: ${error}`, 'error');
            });
        }
        
        // 插入新记录
        function insertRecord() {
            const formData = {};
            const formFields = document.querySelectorAll('#insertFormFields input, #insertFormFields select');
            
            // 收集表单数据
            formFields.forEach(field => {
                let value = field.value;
                
                // 处理特殊值
                if (value === 'null' || value === 'None' || value === '') {
                    value = null;
                }
                
                formData[field.name] = value;
            });
            
            // 发送插入请求
            authenticatedFetch(`/api/tables/${currentTable}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('记录插入成功', 'success');
                    hideInsertForm();
                    loadTableData(); // 重新加载数据
                } else {
                    showStatus(`插入失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`插入失败: ${error}`, 'error');
            });
        }
        
        // 删除记录
        function deleteRecord() {
            const pn = document.getElementById('deletePN').value.trim();
            
            if (!pn) {
                showStatus('请输入要删除记录的PN号', 'error');
                return;
            }
            
            // 验证PN号格式（应该包含连字符）
            if (!pn.includes('-')) {
                showStatus('请输入有效的PN号格式（如：8942-9106-1100）', 'error');
                return;
            }
            
            // 显示确认对话框
            showConfirmModal(`确定要删除PN号为 ${pn} 的记录吗？此操作不可撤销。`, function() {
                showStatus('正在删除记录...', 'loading');
                
                authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('记录删除成功', 'success');
                        document.getElementById('deletePN').value = '';
                        loadTableData(); // 重新加载数据
                    } else {
                        showStatus(`删除失败: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`删除失败: ${error}`, 'error');
                });
            });
        }
        
        // 更新记录计数
        function updateRecordCount() {
            const countElement = document.getElementById('recordCount');
            countElement.textContent = `显示 ${tableData.length} 条记录`;
        }
        
        // 更新表标题
        function updateTableTitle() {
            const titleMap = {
                'wf_open': 'WF Open',
                'wf_closed': 'WF Closed',
                'non_wf_open': 'Non-WF Open',
                'non_wf_closed': 'Non-WF Closed'
            };
            
            const titleElement = document.getElementById('tableTitle');
            titleElement.textContent = `${titleMap[currentTable] || currentTable} 表数据`;
        }
        
        // 显示状态消息
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
        }
        
        // 隐藏状态消息
        function hideStatus() {
            const statusElement = document.getElementById('statusMessage');
            statusElement.style.display = 'none';
        }
    </script>
</body>
</html>