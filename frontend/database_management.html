<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .editable-cell {
            cursor: pointer;
            padding: 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
            min-height: 38px;
            display: table-cell;
            vertical-align: middle;
        }
        .editable-cell:hover {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .editing-cell {
            padding: 0;
        }
        .editing-cell input, .editing-cell select {
            width: 100%;
            border: 1px solid #007bff;
            padding: 8px;
            box-sizing: border-box;
        }
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .filter-row {
            margin-bottom: 10px;
        }
        .filter-row .form-control {
            width: 100%;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .table th, .table td {
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table-responsive {
            overflow-x: auto;
        }
        /* 数据验证错误行样式 */
        .invalid-row {
            background-color: #f8d7da !important;
            color: #721c24;
        }
        .invalid-row:hover {
            background-color: #f1b0b7 !important;
        }
        .invalid-row td {
            border-color: #f5c6cb !important;
        }
        /* 检索框样式调整 */
        .filter-row .col {
            padding-left: 2px;
            padding-right: 2px;
            position: relative;
            min-width: 120px; /* 确保有足够的宽度 */
        }
        .filter-row .form-control-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            width: 100%; /* 确保占满容器宽度 */
            box-sizing: border-box; /* 确保padding不会增加元素总宽度 */
        }
        /* 清除按钮样式 */
        .clear-filter-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1>采购订单管理系统</h1>
            <div class="user-info">
                <span id="currentUser">未登录</span>
                <a href="/register.html" id="registerLink">注册</a>
                <a href="/login.html" id="loginLink" style="display: inline-block;">登录</a>
                <button id="logoutBtn" style="display: none;">退出</button>
            </div>
        </div>
        
        <!-- 导航按钮 -->
        <div class="mb-3">
            <a href="/" class="btn btn-primary">
                <i class="bi bi-table"></i> 数据库管理
            </a>
            <a href="/pdf_import.html" class="btn btn-secondary">
                <i class="bi bi-cloud-upload"></i> PDF导入
            </a>
        </div>
        
        <!-- 状态消息区域 -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <!-- 表选择 -->
        <div class="row mb-3">
            <div class="col-md-4">
                <select class="form-select" id="tableSelect">
                    <option value="wf_open">WF Open</option>
                    <option value="wf_closed">WF Closed</option>
                    <option value="non_wf_open">Non-WF Open</option>
                    <option value="non_wf_closed">Non-WF Closed</option>
                </select>
            </div>
            <div class="col-md-8 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="loadTableData()">
                    <i class="bi bi-arrow-repeat"></i> 刷新数据
                </button>
                <button class="btn btn-success" onclick="showInsertForm()">
                    <i class="bi bi-plus-circle"></i> 插入新记录
                </button>
            </div>
        </div>
        
        <!-- 插入表单 (默认隐藏) -->
        <div id="insertFormContainer" class="table-container" style="display: none;">
            <h5>插入新记录</h5>
            <div id="insertFormFields" class="row g-2"></div>
            <div class="mt-2">
                <button class="btn btn-success me-2" onclick="insertRecord()">插入记录</button>
                <button class="btn btn-secondary" onclick="hideInsertForm()">取消</button>
            </div>
        </div>
        

        
        <!-- 数据表格 -->
        <div class="table-container">
            <h5 id="tableTitle">WF Open 表数据</h5>
            <div id="filterRow" class="filter-row"></div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead id="tableHeader">
                        <!-- 表头将通过JavaScript动态生成 -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- 表体将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            <div id="recordCount" class="mt-2 text-muted"></div>
            <div id="paginationContainer" class="mt-3"></div>
        </div>
    </div>

    <!-- Bootstrap Modal for Confirmation -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    确认要执行此操作吗？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 发货模态框 -->
    <div class="modal fade" id="shipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">发货信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="shipmentPO" class="form-label">PO号</label>
                        <input type="text" class="form-control" id="shipmentPO" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="shipmentPN" class="form-label">PN号</label>
                        <input type="text" class="form-control" id="shipmentPN" readonly>
                    </div>
                    <input type="hidden" id="shipmentPoLine">
                    <div class="mb-3">
                        <label for="shipmentMaxQty" class="form-label">最大可发货数量</label>
                        <input type="text" class="form-control" id="shipmentMaxQty" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="shipmentQty" class="form-label">发货数量 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="shipmentQty" placeholder="输入发货数量" min="0.01" step="0.01">
                        <small class="text-muted">输入的数量不能超过 <span id="maxQtyDisplay">0</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmShipmentBtn">确认发货</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 检查用户是否已登录
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                // 未登录，跳转到登录页面
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        // 在页面加载时检查登录状态
        if (!checkLoginStatus()) {
            // 如果未登录，阻止页面继续加载
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>请先登录</h2><p>正在跳转到登录页面...</p></div>';
            });
        }
        
        // 全局变量
        let currentTable = 'wf_open';
        let tableData = [];
        let originalData = [];
        let filteredData = []; // 用于存储过滤后的数据
        let columnNames = [];
        let dateColumns = ['req_date_wf', 'eta_wfsz', 'latest_departure_date', 'po_placed_date'];
        let currentEditingCell = null; // 跟踪当前正在编辑的单元格
        // 分页相关变量
        let currentPage = 1;
        let itemsPerPage = 20;
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("页面DOM内容加载完成");
                
                // 检查登录状态
                if (!checkLoginStatus()) {
                    return;
                }
                
                // 显示当前用户
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    const currentUserElement = document.getElementById('currentUser');
                    const logoutBtn = document.getElementById('logoutBtn');
                    const loginLink = document.getElementById('loginLink');
                    const registerLink = document.getElementById('registerLink');
                    
                    if (currentUserElement) {
                        currentUserElement.textContent = currentUser.email;
                    }
                    
                    if (logoutBtn) {
                        logoutBtn.style.display = 'inline-block';
                    }
                    
                    if (loginLink) {
                        loginLink.style.display = 'none';
                    }
                    
                    if (registerLink) {
                        registerLink.style.display = 'none';
                    }
                }
                
                // 检查必要的DOM元素是否存在
                const requiredElements = [
                    'tableSelect',
                    'insertForm',
                    'insertFormFields',
                    'tableContainer',
                    'tableHeader',
                    'tableBody',
                    'filterRow',
                    'recordCount',
                    'paginationContainer'
                ];
                
                requiredElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (!element) {
                        console.warn(`未找到id为'${elementId}'的元素`);
                    }
                });
                
                loadTableData();
                
                // 监听表选择变化
                const tableSelect = document.getElementById('tableSelect');
                if (tableSelect) {
                    tableSelect.addEventListener('change', function() {
                        currentTable = this.value;
                        // 清除过滤器
                        clearAllFilters();
                        loadTableData();
                    });
                }
                
                // 监听全局键盘事件
                document.addEventListener('keydown', function(event) {
                    // 避免在输入框中按键时触发全局事件
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    if (currentEditingCell) {
                        if (event.key === 'Escape') {
                            // ESC键取消编辑
                            const input = currentEditingCell.querySelector('input');
                            if (input) {
                                const originalValue = input.getAttribute('data-original-value');
                                input.value = originalValue || '';
                                // 触发change事件更新数据模型
                                input.dispatchEvent(new Event('change'));
                                // 结束编辑状态
                                currentEditingCell.textContent = originalValue || '';
                                currentEditingCell.classList.remove('editing-cell');
                                currentEditingCell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        } else if (event.key === 'Enter') {
                            // Enter键保存编辑
                            const input = currentEditingCell.querySelector('input');
                            if (input) {
                                input.dispatchEvent(new Event('change'));
                                currentEditingCell.textContent = input.value || '';
                                currentEditingCell.classList.remove('editing-cell');
                                currentEditingCell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        }
                    }
                });
                
                // 添加退出按钮事件监听
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function() {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                    });
                }
                
                console.log("页面初始化完成");
            } catch (error) {
                console.error("页面初始化出错:", error);
            }
        });
        
        // 带认证的fetch函数
        function authenticatedFetch(url, options = {}) {
            // 获取存储的token
            const token = localStorage.getItem('authToken');
            if (!token) {
                // 如果没有token，跳转到登录页面
                window.location.href = '/login.html';
                throw new Error('未登录');
            }
            
            // 添加认证头
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // 添加用户邮箱头
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.email) {
                options.headers['X-User-Email'] = currentUser.email;
            }
            
            return fetch(url, options)
                .then(response => {
                    if (response.status === 401) {
                        // Token无效或过期，清除本地存储并跳转到登录页面
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                        throw new Error('认证失败，请重新登录');
                    }
                    return response;
                })
                .catch(error => {
                    if (error.message === '认证失败，请重新登录') {
                        throw error;
                    }
                    // 其他错误继续抛出
                    throw error;
                });
        }
        
        // 获取表的列名
        function getColumnNames(tableName) {
            // 根据表名返回对应的列顺序
            const tableColumns = {
                'wf_open': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'latest_departure_date', 'chinese_name', 'unit'],
                'wf_closed': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'chinese_name', 'unit'],
                'non_wf_open': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'qc_result', 'shipping_cost', 'tracking_no', 'so_number', 'yes_not_paid'],
                'non_wf_closed': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'shipping_cost', 'tracking_no', 'so_number', 'yes_not_paid']
            };
            
            // 返回对应表的列顺序，如果没有定义则返回默认顺序
            return tableColumns[tableName] || ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'po_placed_date', 'purchaser'];
        }
        
        // 获取列的显示名称
        function getColumnDisplayName(columnName) {
            const displayNameMap = {
                'po': '采购订单号',
                'pn': '零件号',
                'line': '行号',
                'po_line': 'PO/行号',
                'description': '描述',
                'qty': '数量',
                'net_price': '净价',
                'total_price': '总价',
                'req_date_wf': '要求日期(WF)',
                'req_date': '要求日期',
                'eta_wfsz': 'ETA WFSZ',
                'shipping_mode': '运输方式',
                'comment': '备注',
                'po_placed_date': '采购订单下达日期',
                'purchaser': '采购员',
                'record_no': '记录号',
                'shipping_cost': '运费',
                'tracking_no': '追踪号',
                'so_number': '销售订单号',
                'latest_departure_date': '最晚发货日期',
                'chinese_name': '中文名称',
                'unit': '单位',
                'qc_result': '质检结果',
                'yes_not_paid': '是否已付款'
            };
            
            return displayNameMap[columnName] || columnName;
        }
        
        // 加载表数据
        function loadTableData() {
            showStatus('正在加载数据...', 'loading');
            
            authenticatedFetch(`/api/tables/${currentTable}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        tableData = data.data;
                        filteredData = [...tableData]; // 初始化过滤数据
                        // 根据表名获取正确的列顺序
                        columnNames = getColumnNames(currentTable);
                        originalData = JSON.parse(JSON.stringify(tableData));
                        // 重置到第一页
                        currentPage = 1;
                        renderTable();
                        // 确保过滤行在数据加载后正确显示
                        setTimeout(() => {
                            renderFilterRow();
                        }, 0);
                        hideStatus();
                    } else {
                        showStatus(`加载数据失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`加载数据失败: ${error}`, 'error');
                });
        }
        
        // 渲染表格
        function renderTable() {
            renderTableHeader();
            renderTableBody();
            renderFilterRow();  // 恢复过滤行渲染
            updateRecordCount();
            renderPagination();
            updateTableTitle();
        }
        
        // 渲染表体
        function renderTableBody() {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            
            // 计算分页数据
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            let tableHtml = '';
            paginatedData.forEach((row, index) => {
                // 使用实际的行索引而不是分页后的索引
                const rowIndex = startIndex + index;
                
                // 检查 qty*net_price 是否等于 total_price
                const qty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = qty * netPrice;
                
                // 检查计算值是否与总价匹配（考虑浮点数精度问题）
                const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
                
                // 构建行的class属性
                let rowClass = '';
                if (isInvalidRow) {
                    rowClass = 'invalid-row';
                }
                
                let rowHtml = `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                
                // 先添加操作列
                const pn = row['pn'] || '';
                const po = row['po'] || '';
                const poLine = row['po_line'] || '';
                const rowQty = parseFloat(row.qty) || 0;
                const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
                
                rowHtml += `<td style="text-align: center;">`;
                
                // 发货按钮（仅在Open表显示）
                if (isOpenTable) {
                    rowHtml += `<button class="btn btn-sm btn-primary me-1" onclick="showShipmentDialog('${po}', '${pn}', '${poLine}', ${rowQty})" title="发货">
                        <i class="bi bi-box-seam"></i>
                    </button>`;
                }
                
                // 删除按钮
                rowHtml += `<button class="btn btn-sm btn-danger" onclick="deleteRowRecord('${pn}')" title="删除此记录">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>`;
                
                // 再添加数据列
                columnNames.forEach(col => {
                    const value = row[col] !== null ? row[col] : '';
                    // 格式化日期值
                    let displayValue = value;
                    if (value && typeof value === 'object' && value.hasOwnProperty('$$date')) {
                        // 处理特殊日期格式
                        const date = new Date(value.$$date);
                        displayValue = date.toLocaleDateString('zh-CN');
                    } else if (value && typeof value === 'string' && value.includes('GMT')) {
                        // 处理GMT日期字符串
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                displayValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            // 如果不是有效日期，保持原值
                            displayValue = value;
                        }
                    } else if (value === null || value === 'None' || value === 'null') {
                        displayValue = '';
                    }
                    
                    // 确保特殊字符被正确转义
                    const escapedValue = String(displayValue).replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    
                    rowHtml += `<td class="editable-cell" data-column="${col}" data-row="${rowIndex}" onclick="editCell(this)">${escapedValue}</td>`;
                });
                
                rowHtml += '</tr>';
                tableHtml += rowHtml;
            });
            
            body.innerHTML = tableHtml;
            paginatedData.forEach((row, index) => {
                const rowIndex = startIndex + index;
                const checkQty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = checkQty * netPrice;
                
                // 检查计算值是否与总价匹配（考虑浮点数精度问题）
                if (checkQty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01) {
                    const rowElement = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                    if (rowElement) {
                        rowElement.title = `数据不一致: qty(${checkQty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} ≠ total_price(${totalPrice})`;
                    }
                }
            });
        }
        
        // 渲染表头
        function renderTableHeader() {
            const header = document.getElementById('tableHeader');
            header.innerHTML = '';
            
            let headerHtml = '<tr>';
            headerHtml += '<th>操作</th>';
            columnNames.forEach(col => {
                headerHtml += `<th>${col}</th>`;
            });
            headerHtml += '</tr>';
            
            header.innerHTML = headerHtml;
        }
        
        // 渲染过滤行
        function renderFilterRow() {
            const filterRow = document.getElementById('filterRow');
            if (!filterRow) {
                console.error('Filter row element not found');
                return;
            }
            
            // 创建一个单独的行用于过滤器
            let filterHtml = '<div class="row">';
            
            // 为操作列添加清除按钮
            filterHtml += `
                <div class="col">
                    <button class="btn btn-sm btn-outline-secondary clear-filter-btn" onclick="clearAllFilters()">
                        <i class="bi bi-x-circle"></i> 清除
                    </button>
                </div>
            `;
            
            // 为每个数据列创建过滤器
            columnNames.forEach((col, index) => {
                filterHtml += `
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" 
                               placeholder="${col}" 
                               data-column="${col}"
                               oninput="filterTable(this)">
                    </div>
                `;
            });
            
            filterHtml += '</div>';
            
            filterRow.innerHTML = filterHtml;
            
            // 设置过滤器事件
            setupFilterEvents();
        }
        
        // 过滤表格
        function filterTable(input) {
            // 直接应用过滤器，不使用防抖
            applyAllFilters();
        }
        
        // 应用所有过滤器
        function applyAllFilters() {
            // 获取所有过滤器输入框
            const filterInputs = document.querySelectorAll('input[data-column]');
            
            // 保存当前的输入值，避免重新渲染时丢失
            const currentValues = {};
            filterInputs.forEach(input => {
                currentValues[input.getAttribute('data-column')] = input.value;
            });
            
            // 从原始数据开始过滤
            filteredData = [...tableData];
            
            // 应用每个有过滤值的过滤器
            filterInputs.forEach(input => {
                const column = input.getAttribute('data-column');
                const filterValue = input.value.trim().toLowerCase();
                
                if (filterValue) {
                    filteredData = filteredData.filter(row => {
                        const cellValue = (row[column] || '').toString().toLowerCase();
                        return cellValue.includes(filterValue);
                    });
                }
            });
            
            // 重置到第一页并重新渲染
            currentPage = 1;
            renderTableBody();
            updateRecordCount();
            renderPagination();
            
            // 恢复输入框的值
            setTimeout(() => {
                filterInputs.forEach(input => {
                    const column = input.getAttribute('data-column');
                    if (currentValues[column] !== undefined) {
                        input.value = currentValues[column];
                    }
                });
            }, 0);
        }
        
        // 为过滤器添加回车键事件
        function setupFilterEvents() {
            const filterInputs = document.querySelectorAll('input[data-column]');
            filterInputs.forEach(input => {
                // 确保移除之前可能添加的事件监听器
                input.removeEventListener('keyup', handleFilterKeyUp);
                // 添加新的事件监听器
                input.addEventListener('keyup', handleFilterKeyUp);
            });
        }
        
        // 处理过滤器的keyup事件
        function handleFilterKeyUp(event) {
            if (event.key === 'Enter') {
                applyAllFilters();
            }
        }
        
        // 清除所有过滤器
        function clearAllFilters() {
            // 清除所有过滤器输入框的值
            const filterInputs = document.querySelectorAll('input[data-column]');
            filterInputs.forEach(input => {
                input.value = '';
            });
            
            // 重置过滤数据为原始数据
            filteredData = [...tableData];
            
            // 重置到第一页并重新渲染
            currentPage = 1;
            renderTableBody();
            updateRecordCount();
            renderPagination();
        }
        
        // 显示确认对话框
        function showConfirmModal(message, confirmCallback) {
            // 设置模态框内容
            document.getElementById('confirmModalBody').innerHTML = message;
            
            // 设置确认按钮的点击事件
            const confirmButton = document.getElementById('confirmModalButton');
            // 清除之前的事件监听器
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // 添加新的点击事件监听器
            newConfirmButton.onclick = function() {
                // 关闭模态框
                const modalElement = document.getElementById('confirmModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                // 执行确认回调
                if (confirmCallback && typeof confirmCallback === 'function') {
                    confirmCallback();
                }
            };
            
            // 显示模态框
            const modalElement = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // 编辑单元格
        function editCell(cell) {
            // 如果点击的是输入框，不执行编辑操作
            if (event && event.target.tagName === 'INPUT') {
                return;
            }
            
            // 如果有正在编辑的单元格，先取消它的编辑状态
            if (currentEditingCell && currentEditingCell !== cell) {
                // 检查当前编辑的单元格是否有未保存的更改
                const input = currentEditingCell.querySelector('input');
                if (input) {
                    // 触发change事件保存更改
                    input.dispatchEvent(new Event('change'));
                }
                // 恢复单元格显示
                const originalValue = currentEditingCell.getAttribute('data-original-value');
                currentEditingCell.textContent = originalValue || '';
                currentEditingCell.classList.remove('editing-cell');
                currentEditingCell.classList.add('editable-cell');
            }
            
            // 如果点击的是已经处于编辑状态的单元格，则不做任何操作
            if (cell.classList.contains('editing-cell')) {
                return;
            }
            
            const rowIndex = parseInt(cell.getAttribute('data-row'));
            const columnName = cell.getAttribute('data-column');
            const currentValue = cell.textContent || '';
            
            // 保存原始值
            cell.setAttribute('data-original-value', currentValue);
            
            // 根据列名判断输入类型
            let inputHtml = '';
            if (dateColumns.includes(columnName)) {
                // 对于日期字段，确保值格式正确
                let dateValue = currentValue;
                if (currentValue && currentValue !== 'null' && currentValue !== 'None') {
                    // 如果是日期对象，格式化为 YYYY-MM-DD
                    if (currentValue instanceof Date) {
                        dateValue = currentValue.toISOString().split('T')[0];
                    } else if (typeof currentValue === 'string' && currentValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                        // 已经是正确格式
                        dateValue = currentValue;
                    } else if (typeof currentValue === 'string' && currentValue.includes('GMT')) {
                        // 处理GMT日期字符串
                        try {
                            const date = new Date(currentValue);
                            if (!isNaN(date.getTime())) {
                                dateValue = date.toISOString().split('T')[0];
                            }
                        } catch (e) {
                            dateValue = currentValue;
                        }
                    }
                } else {
                    dateValue = '';
                }
                inputHtml = `<input type="date" class="date-input" value="${dateValue}" 
                                     onchange="updateCellValue(${rowIndex}, '${columnName}', this.value)"
                                     data-original-value="${dateValue}">`;
            } else {
                inputHtml = `<input type="text" value="${currentValue}" 
                                     onchange="updateCellValue(${rowIndex}, '${columnName}', this.value)"
                                     data-original-value="${currentValue}">`;
            }
            
            cell.innerHTML = inputHtml;
            cell.classList.add('editing-cell');
            cell.classList.remove('editable-cell');
            
            // 聚焦到新创建的输入框
            const input = cell.querySelector('input');
            if (input) {
                input.focus();
                // 选择所有文本以便编辑
                input.select();
                
                // 为输入框添加键盘事件监听
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        event.stopPropagation();
                        // ESC键取消编辑，恢复原始值
                        const originalValue = input.getAttribute('data-original-value');
                        input.value = originalValue || '';
                        // 触发change事件更新数据模型
                        input.dispatchEvent(new Event('change'));
                        // 结束编辑状态
                        cell.textContent = originalValue || '';
                        cell.classList.remove('editing-cell');
                        cell.classList.add('editable-cell');
                        currentEditingCell = null;
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        event.stopPropagation();
                        // Enter键保存编辑
                        input.dispatchEvent(new Event('change'));
                        cell.textContent = input.value || '';
                        cell.classList.remove('editing-cell');
                        cell.classList.add('editable-cell');
                        currentEditingCell = null;
                    }
                });
                
                // 监听输入框失去焦点事件
                input.addEventListener('blur', function() {
                    // 延迟执行，确保不会与点击事件冲突
                    setTimeout(() => {
                        if (currentEditingCell === cell) {
                            // 触发change事件保存更改
                            input.dispatchEvent(new Event('change'));
                            cell.textContent = input.value || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    }, 200);
                });
            }
            
            // 设置当前编辑的单元格
            currentEditingCell = cell;
        }
        
        // 更新单元格值
        function updateCellValue(rowIndex, columnName, value) {
            // 处理特殊值
            if (value === 'null' || value === 'None' || value === 'nan') {
                tableData[rowIndex][columnName] = null;
            } else {
                tableData[rowIndex][columnName] = value;
            }
            
            // 检查是否是qty或net_price列，如果是则自动计算total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                const totalPrice = (qty * netPrice).toFixed(2);
                
                // 更新total_price字段
                tableData[rowIndex]['total_price'] = totalPrice;
                
                // 更新表格中显示的total_price值
                const totalCell = document.querySelector(`td[data-column="total_price"][data-row="${rowIndex}"]`);
                if (totalCell) {
                    totalCell.textContent = totalPrice;
                }
            }
            
            // 实时保存到数据库
            saveCellValueToDatabase(rowIndex, columnName, value);
        }
        
        // 保存单元格编辑
        function saveCellEdit(cell) {
            // 触发输入框的change事件来保存值
            const input = cell.querySelector('input');
            if (input) {
                input.dispatchEvent(new Event('change'));
            }
            // 更新显示值
            if (input) {
                cell.textContent = input.value || '';
            }
            cell.classList.remove('editing-cell');
            cell.classList.add('editable-cell');
        }
        
        // 保存单元格数据（自动保存）
        function saveCellData(rowIndex, columnName, value) {
            // 更新数据模型
            tableData[rowIndex][columnName] = value;
            
            // 如果是qty或net_price，同时更新total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                tableData[rowIndex]['total_price'] = (qty * netPrice).toFixed(2);
            }
            
            // 获取主键值（假设为pn字段）
            const row = tableData[rowIndex];
            const pn = row.pn || row.PN;
            
            if (!pn) {
                showStatus('无法保存：缺少主键值(pn)', 'error');
                return;
            }
            
            // 准备更新数据
            const updates = {};
            updates[columnName] = value;
            
            // 如果是qty或net_price，同时发送total_price更新
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // 发送更新请求
            authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新原始数据
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`数据已保存: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // 重新验证该行数据（仅对数值列）
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`保存失败: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('保存数据时出错:', error);
                showStatus(`保存失败: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }
        
        // 实时保存单元格值到数据库
        function saveCellValueToDatabase(rowIndex, columnName, value) {
            // 获取要更新的数据
            const rowData = tableData[rowIndex];
            const pn = rowData.pn;
            
            // 构造更新数据
            const updates = {};
            updates[columnName] = value;
            
            // 如果是qty或net_price，同时更新total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // 发送更新请求
            authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新原始数据
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`数据已保存: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // 重新验证该行数据（仅对数值列）
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`保存失败: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('保存数据时出错:', error);
                showStatus(`保存失败: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }

        // 验证行数据
        function validateRow(rowIndex) {
            const row = tableData[rowIndex];
            // 确保必要的列存在
            if (!row.hasOwnProperty('qty') || !row.hasOwnProperty('net_price') || !row.hasOwnProperty('total_price')) {
                return;
            }
            
            const qty = parseFloat(row.qty) || 0;
            const netPrice = parseFloat(row.net_price) || 0;
            const totalPrice = parseFloat(row.total_price) || 0;
            const calculatedTotal = qty * netPrice;
            
            // 检查计算值是否与总价匹配（考虑浮点数精度问题）
            const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
            
            const rowElement = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (rowElement) {
                if (isInvalidRow) {
                    rowElement.classList.add('invalid-row');
                    rowElement.title = `数据不一致: qty(${qty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} ≠ total_price(${totalPrice})`;
                } else {
                    rowElement.classList.remove('invalid-row');
                    rowElement.title = '';
                }
            }
        }
        
        // 保存行数据
        function saveRow(rowIndex) {
            const row = tableData[rowIndex];
            const originalRow = originalData[rowIndex];
            
            // 检查是否有更改
            let hasChanges = false;
            for (let key in row) {
                if (row[key] !== originalRow[key]) {
                    hasChanges = true;
                    break;
                }
            }
            
            if (!hasChanges) {
                showStatus('没有更改需要保存', 'info');
                return;
            }
            
            // 获取主键值（假设为pn字段）
            const pn = row.pn || row.PN;
            if (!pn) {
                showStatus('无法保存：缺少主键值(pn)', 'error');
                return;
            }
            
            showStatus('正在保存数据...', 'loading');
            
            authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(row)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('数据保存成功', 'success');
                    // 更新原始数据副本
                    originalData[rowIndex] = JSON.parse(JSON.stringify(row));
                } else {
                    showStatus(`保存失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`保存失败: ${error}`, 'error');
            });
        }
        
        // 插入新记录
        function insertRecord() {
            try {
                const formData = {};
                const formFields = document.querySelectorAll('#insertFormFields input, #insertFormFields select');
                
                // 收集表单数据
                formFields.forEach(field => {
                    let value = field.value;
                    
                    // 处理特殊值
                    if (value === 'null' || value === 'None' || value === '') {
                        value = null;
                    }
                    
                    formData[field.name] = value;
                });
                
                // 发送插入请求
                authenticatedFetch(`/api/tables/${currentTable}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('记录插入成功', 'success');
                        hideInsertForm();
                        loadTableData(); // 重新加载数据
                    } else {
                        showStatus(`插入失败: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`插入失败: ${error}`, 'error');
                });
            } catch (error) {
                console.error("insertRecord函数执行出错:", error);
                showStatus(`插入记录时出错: ${error.message}`, 'error');
            }
        }
        

        
        // 显示插入表单
        function showInsertForm() {
            try {
                console.log("showInsertForm函数被调用");
                
                const insertForm = document.getElementById('insertFormContainer');
                
                if (!insertForm) {
                    console.error("未找到id为'insertFormContainer'的元素");
                    return;
                }
                
                // 如果表单已经展开，则隐藏（作为取消）
                if (insertForm.style.display === 'block') {
                    hideInsertForm();
                    return;
                }
                
                const insertFormFields = document.getElementById('insertFormFields');
                
                if (!insertFormFields) {
                    console.error("未找到id为'insertFormFields'的元素");
                    return;
                }
                
                const columns = getColumnNames(currentTable);
                console.log("当前表的列名:", columns);
                
                let formHtml = '';
                columns.forEach(column => {
                    if (column === 'total_price') return;
                    formHtml += `<div class="col-md-3 mb-2"><input type="text" class="form-control form-control-sm" name="${column}" placeholder="${column}"></div>`;
                });
                
                insertFormFields.innerHTML = formHtml;
                
                insertForm.style.display = 'block';
                const tableContainers = document.querySelectorAll('.table-container');
                if (tableContainers.length > 0) {
                    tableContainers[tableContainers.length - 1].style.display = 'none';
                }
                
                console.log("插入表单已显示");
            } catch (error) {
                console.error("showInsertForm函数执行出错:", error);
                alert("显示插入表单时出错: " + error.message);
            }
        }
        
        // 隐藏插入表单
        function hideInsertForm() {
            try {
                console.log("hideInsertForm函数被调用");
                
                // 检查必要的DOM元素是否存在
                const insertForm = document.getElementById('insertFormContainer');
                const insertFormFields = document.getElementById('insertFormFields');
                
                if (!insertForm) {
                    console.error("未找到id为'insertFormContainer'的元素");
                    return;
                }
                
                if (!insertFormFields) {
                    console.error("未找到id为'insertFormFields'的元素");
                    return;
                }
                
                // 隐藏插入表单，显示数据表格
                insertForm.style.display = 'none';
                // 显示最后一个容器（数据表格）
                const tableContainers = document.querySelectorAll('.table-container');
                if (tableContainers.length > 0) {
                    tableContainers[tableContainers.length - 1].style.display = 'block';
                }
                
                // 清空表单字段
                insertFormFields.innerHTML = '';
                
                console.log("插入表单已隐藏");
            } catch (error) {
                console.error("hideInsertForm函数执行出错:", error);
                console.log("隐藏插入表单时出错: " + error.message);
            }
        }
        
        
        // 从行操作中删除记录
        // 显示发货对话框
        function showShipmentDialog(po, pn, poLine, maxQty) {
            // 设置对话框信息
            document.getElementById('shipmentPO').value = po || '';
            document.getElementById('shipmentPN').value = pn || '';
            document.getElementById('shipmentPoLine').value = poLine || '';
            document.getElementById('shipmentMaxQty').value = maxQty || 0;
            document.getElementById('shipmentQty').value = '';
            document.getElementById('maxQtyDisplay').textContent = maxQty || 0;
            
            // 清除之前的input值
            const qtyInput = document.getElementById('shipmentQty');
            if (qtyInput) {
                qtyInput.max = maxQty;
                qtyInput.value = '';
                qtyInput.focus();
            }
            
            // 显示模态框
            const modalElement = document.getElementById('shipmentModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // 设置发货确认按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            const confirmShipmentBtn = document.getElementById('confirmShipmentBtn');
            if (confirmShipmentBtn) {
                confirmShipmentBtn.addEventListener('click', confirmShipment);
            }
        });
        
        // 发货确认函数
        function confirmShipment() {
            const po = document.getElementById('shipmentPO').value;
            const pn = document.getElementById('shipmentPN').value;
            const poLine = document.getElementById('shipmentPoLine').value;
            const maxQty = parseFloat(document.getElementById('shipmentMaxQty').value);
            const shipmentQty = parseFloat(document.getElementById('shipmentQty').value);
            
            // 验证
            if (!pn || !po) {
                showStatus('PO号或PN号缺失', 'error');
                return;
            }
            
            if (!shipmentQty || shipmentQty <= 0) {
                showStatus('请输入有效的发货数量', 'error');
                return;
            }
            
            if (shipmentQty > maxQty) {
                showStatus(`发货数量不能超过${maxQty}`, 'error');
                return;
            }
            
            showStatus('正在处理发货...', 'loading');
            
            // 发送发货请求
            authenticatedFetch('/api/shipment/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    source_table: currentTable,
                    po: po,
                    pn: pn,
                    po_line: poLine,
                    shipment_qty: shipmentQty,
                    max_qty: maxQty
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('发货处理成功', 'success');
                    // 关闭模态框
                    const modalElement = document.getElementById('shipmentModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    // 重新加载表数据
                    loadTableData();
                } else {
                    showStatus(`发货失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`发货失败: ${error}`, 'error');
            });
        }
        
        function deleteRowRecord(pn) {
            if (!pn) {
                showStatus('无法获取记录的PN号', 'error');
                return;
            }
            
            // 显示确认对话框
            showConfirmModal(`确定要删除PN号为 ${pn} 的记录吗？此操作不可撤销。`, function() {
                showStatus('正在删除记录...', 'loading');
                
                authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('记录删除成功', 'success');
                        loadTableData(); // 重新加载数据
                    } else {
                        showStatus(`删除失败: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`删除失败: ${error}`, 'error');
                });
            });
        }
        
        // 删除记录
        function deleteRecord() {
            const pn = document.getElementById('deletePN').value.trim();
            
            if (!pn) {
                showStatus('请输入要删除记录的PN号', 'error');
                return;
            }
            
            // 验证PN号格式（应该包含连字符）
            if (!pn.includes('-')) {
                showStatus('请输入有效的PN号格式（如：8942-9106-1100）', 'error');
                return;
            }
            
            // 显示确认对话框
            showConfirmModal(`确定要删除PN号为 ${pn} 的记录吗？此操作不可撤销。`, function() {
                showStatus('正在删除记录...', 'loading');
                
                authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('记录删除成功', 'success');
                        document.getElementById('deletePN').value = '';
                        loadTableData(); // 重新加载数据
                    } else {
                        showStatus(`删除失败: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`删除失败: ${error}`, 'error');
                });
            });
        }
        
        // 更新记录计数
        function updateRecordCount() {
            const countElement = document.getElementById('recordCount');
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
            countElement.textContent = `显示第 ${startIndex}-${endIndex} 条记录，共 ${filteredData.length} 条记录`;
        }
        
        // 渲染分页控件
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            // 如果只有一页或没有数据，则不显示分页控件
            if (totalPages <= 1) {
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }
            
            let paginationHtml = `
                <nav aria-label="分页导航">
                    <ul class="pagination justify-content-center">
            `;
            
            // 上一页按钮
            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">上一页</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <span class="page-link">上一页</span>
                    </li>
                `;
            }
            
            // 页码按钮
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // 确保始终显示5个页码按钮（如果可能）
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHtml += `
                        <li class="page-item active">
                            <span class="page-link">${i}</span>
                        </li>
                    `;
                } else {
                    paginationHtml += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                }
            }
            
            // 下一页按钮
            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">下一页</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <span class="page-link">下一页</span>
                    </li>
                `;
            }
            
            paginationHtml += `
                    </ul>
                </nav>
            `;
            
            document.getElementById('paginationContainer').innerHTML = paginationHtml;
        }
        
        // 切换页面
        function changePage(pageNumber) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                currentPage = pageNumber;
                renderTableBody();
                updateRecordCount();
                renderPagination();
            }
        }
        
        // 更新表标题
        function updateTableTitle() {
            const titleMap = {
                'wf_open': 'WF Open',
                'wf_closed': 'WF Closed',
                'non_wf_open': 'Non-WF Open',
                'non_wf_closed': 'Non-WF Closed'
            };
            
            const titleElement = document.getElementById('tableTitle');
            titleElement.textContent = `${titleMap[currentTable] || currentTable} 表数据`;
        }
        
        // 显示状态消息
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
        }
        
        // 隐藏状态消息
        function hideStatus() {
            const statusElement = document.getElementById('statusMessage');
            statusElement.style.display = 'none';
        }
    </script>
</body>
</html>